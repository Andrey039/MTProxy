<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTProxy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #d1d5db;
            line-height: 1.6;
        }
        
        .header {
            background: #1f2937;
            padding: 1rem 2rem;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .header h1 {
            color: #f59e0b;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: auto;
        }
        
        .status-excellent { background: #065f46; color: #10b981; }
        .status-good { background: #78350f; color: #f59e0b; }
        .status-working { background: #9a3412; color: #f97316; }
        .status-problems { background: #7f1d1d; color: #ef4444; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #f9fafb;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #374151;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-name {
            color: #d1d5db;
        }
        
        .metric-value-small {
            color: #10b981;
            font-weight: 600;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
            position: relative;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            grid-column: 1 / -1;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #9ca3af;
        }
        
        .error {
            color: #ef4444;
            text-align: center;
            padding: 2rem;
        }
        
        .refresh-info {
            text-align: center;
            color: #9ca3af;
            font-size: 0.875rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ MTProxy Dashboard</h1>
        <div id="status-badge" class="status-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <div class="container">
        <div class="grid">
            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä –°—Ç–∞—Ç—É—Å</h3>
                </div>
                <div id="main-status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                </div>
                <div id="connections-info" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà –¢—Ä–∞—Ñ–∏–∫</h3>
                </div>
                <div id="traffic-info" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="card chart-container">
                <div class="card-header">
                    <h3 class="card-title">üìä –¢—Ä–∞—Ñ–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h3>
                </div>
                <canvas id="trafficChart"></canvas>
            </div>
            
            <div class="chart-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîÑ –ó–∞–ø—Ä–æ—Å—ã/—Å–µ–∫</h3>
                    </div>
                    <canvas id="requestsChart"></canvas>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h3>
                    </div>
                    <canvas id="connectionsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="refresh-info">
            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#d1d5db' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#374151' }
                },
                y: {
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#374151' }
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const trafficChart = new Chart(document.getElementById('trafficChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: '–ó–∞–≥—Ä—É–∑–∫–∞ (KB/s)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true
                    },
                    {
                        label: '–û—Ç–¥–∞—á–∞ (KB/s)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true
                    }
                ]
            },
            options: chartConfig
        });

        const requestsChart = new Chart(document.getElementById('requestsChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: '–ó–∞–ø—Ä–æ—Å—ã/—Å–µ–∫',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true
                    }
                ]
            },
            options: chartConfig
        });

        const connectionsChart = new Chart(document.getElementById('connectionsChart'), {
            type: 'doughnut',
            data: {
                labels: ['–ö–ª–∏–µ–Ω—Ç—ã', 'Telegram —Å–µ—Ä–≤–µ—Ä—ã'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#10b981', '#3b82f6'],
                    borderColor: '#1f2937',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#d1d5db' }
                    }
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        function updateStatus(data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ö–µ–¥–µ—Ä–µ
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = data.status;
            statusBadge.className = 'status-badge ' + getStatusClass(data.status);

            // –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞—Ç—É—Å
            document.getElementById('main-status').innerHTML = `
                <div class="metric-value">${data.status}</div>
                <div class="metric-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${data.uptime}</div>
            `;

            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            document.getElementById('connections-info').innerHTML = `
                <div class="metric-row">
                    <span class="metric-name">–ö–ª–∏–µ–Ω—Ç—ã</span>
                    <span class="metric-value-small">${data.connections.clients}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Telegram —Å–µ—Ä–≤–µ—Ä—ã</span>
                    <span class="metric-value-small">${data.connections.telegram_servers}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
                    <span class="metric-value-small">${data.connections.total_active}</span>
                </div>
            `;

            // –¢—Ä–∞—Ñ–∏–∫
            document.getElementById('traffic-info').innerHTML = `
                <div class="metric-row">
                    <span class="metric-name">–ü–æ–ª—É—á–µ–Ω–æ</span>
                    <span class="metric-value-small">${data.traffic.total.received}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                    <span class="metric-value-small">${data.traffic.total.sent}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                    <span class="metric-value-small">${data.traffic.current_speed.total}</span>
                </div>
            `;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            updateCharts(data);
            
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        function updateCharts(data) {
            const now = new Date().toLocaleTimeString();
            
            // –ü–∞—Ä—Å–∏–º —Å–∫–æ—Ä–æ—Å—Ç–∏
            const downloadSpeed = parseFloat(data.traffic.current_speed.download) || 0;
            const uploadSpeed = parseFloat(data.traffic.current_speed.upload) || 0;
            const requestsPerSec = parseFloat(data.requests.per_second.queries) || 0;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞
            trafficChart.data.labels.push(now);
            trafficChart.data.datasets[0].data.push(downloadSpeed);
            trafficChart.data.datasets[1].data.push(uploadSpeed);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫
            if (trafficChart.data.labels.length > 20) {
                trafficChart.data.labels.shift();
                trafficChart.data.datasets[0].data.shift();
                trafficChart.data.datasets[1].data.shift();
            }
            trafficChart.update('none');

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
            requestsChart.data.labels.push(now);
            requestsChart.data.datasets[0].data.push(requestsPerSec);
            
            if (requestsChart.data.labels.length > 20) {
                requestsChart.data.labels.shift();
                requestsChart.data.datasets[0].data.shift();
            }
            requestsChart.update('none');

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            connectionsChart.data.datasets[0].data = [
                data.connections.clients,
                data.connections.telegram_servers
            ];
            connectionsChart.update('none');
        }

        function getStatusClass(status) {
            if (status.includes('üü¢')) return 'status-excellent';
            if (status.includes('üü°')) return 'status-good';
            if (status.includes('üü†')) return 'status-working';
            return 'status-problems';
        }

        function showError(message) {
            document.getElementById('main-status').innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${message}</div>`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function fetchData() {
            try {
                const response = await fetch('/status');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                updateStatus(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError(error.message);
            }
        }

        // –ó–∞–ø—É—Å–∫
        fetchData();
        setInterval(fetchData, 5000);
    </script>
</body>
</html>